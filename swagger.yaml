openapi: 3.0.3
info:
  title: Hubee V2 API
  description: |
    RESTful API for managing data streams, packages, subscriptions, and organizations.
    
    **Philosophy:**
    - RESTful + JSON + Bearer Auth
    - Flat Responses: index = array direct, show = object direct
    - Pagination: Headers HTTP (X-Page, X-Total), body remains array direct
    - All IDs are UUIDs (v4)
    
    **Authentication:**
    - Bearer Token: `Authorization: Bearer <token>`
    - Permissions: (r) = read, (w) = write
  version: 1.2.0
  contact:
    name: Hubee API Support

servers:
  - url: /api/v1
    description: API v1

tags:
  - name: Organizations
    description: Organization management
  - name: Data Streams
    description: Data stream management
  - name: Subscriptions
    description: Subscription management
  - name: Data Packages
    description: Data package management
  - name: Transmissions
    description: Data package transmission

paths:
  /organizations:
    get:
      tags:
        - Organizations
      summary: List all organizations
      description: Returns a paginated list of organizations
      operationId: listOrganizations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Successful response
          headers:
            X-Page:
              schema:
                type: integer
              description: Current page number
            X-Per-Page:
              schema:
                type: integer
              description: Items per page
            X-Total:
              schema:
                type: integer
              description: Total number of items
            X-Total-Pages:
              schema:
                type: integer
              description: Total number of pages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /organizations/{id}:
    get:
      tags:
        - Organizations
      summary: Get organization by ID
      description: Returns a single organization
      operationId: getOrganization
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/OrganizationId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /organizations/{id}/subscriptions:
    get:
      tags:
        - Subscriptions
      summary: List subscriptions for an organization
      description: Returns subscriptions for a specific organization (admin-only)
      operationId: listOrganizationSubscriptions
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/OrganizationId'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Successful response
          headers:
            X-Page:
              schema:
                type: integer
            X-Per-Page:
              schema:
                type: integer
            X-Total:
              schema:
                type: integer
            X-Total-Pages:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_streams:
    get:
      tags:
        - Data Streams
      summary: List all data streams
      description: Returns a paginated list of data streams
      operationId: listDataStreams
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Successful response
          headers:
            X-Page:
              schema:
                type: integer
            X-Per-Page:
              schema:
                type: integer
            X-Total:
              schema:
                type: integer
            X-Total-Pages:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DataStream'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    post:
      tags:
        - Data Streams
      summary: Create a data stream
      description: Creates a new data stream (requires write permission)
      operationId: createDataStream
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - data_stream
              properties:
                data_stream:
                  $ref: '#/components/schemas/DataStreamInput'
      responses:
        '201':
          description: Data stream created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataStream'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_streams/{id}:
    get:
      tags:
        - Data Streams
      summary: Get data stream by ID
      description: Returns a single data stream
      operationId: getDataStream
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataStream'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    put:
      tags:
        - Data Streams
      summary: Update a data stream
      description: Updates an existing data stream (requires write permission)
      operationId: updateDataStream
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - data_stream
              properties:
                data_stream:
                  $ref: '#/components/schemas/DataStreamInput'
      responses:
        '200':
          description: Data stream updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataStream'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    delete:
      tags:
        - Data Streams
      summary: Delete a data stream
      description: Deletes a data stream (requires write permission, only if no notifications exist)
      operationId: deleteDataStream
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
      responses:
        '204':
          description: Data stream deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_streams/{id}/subscriptions:
    get:
      tags:
        - Subscriptions
      summary: List subscriptions for a data stream
      description: Returns subscriptions for a specific data stream, optionally filtered by permission type
      operationId: listDataStreamSubscriptions
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
        - name: permission_type
          in: query
          description: 'Filter by permission types (comma-separated). Valid values: read, write, read_write'
          required: false
          schema:
            type: string
            example: 'read,read_write'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Successful response
          headers:
            X-Page:
              schema:
                type: integer
            X-Per-Page:
              schema:
                type: integer
            X-Total:
              schema:
                type: integer
            X-Total-Pages:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    post:
      tags:
        - Subscriptions
      summary: Create a subscription
      description: Creates a new subscription for a data stream (requires write permission)
      operationId: createSubscription
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subscription
              properties:
                subscription:
                  $ref: '#/components/schemas/SubscriptionInput'
      responses:
        '201':
          description: Subscription created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_streams/{id}/data_packages:
    get:
      tags:
        - Data Packages
      summary: List data packages for a data stream
      description: Returns data packages for a specific data stream
      operationId: listDataStreamPackages
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
        - name: state
          in: query
          description: 'Filter by state (comma-separated). Valid values: draft, transmitted, acknowledged'
          required: false
          schema:
            type: string
            example: 'draft,transmitted'
        - name: sender_organization_id
          in: query
          description: Filter by sender organization ID
          required: false
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Successful response
          headers:
            X-Page:
              schema:
                type: integer
            X-Per-Page:
              schema:
                type: integer
            X-Total:
              schema:
                type: integer
            X-Total-Pages:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DataPackage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    post:
      tags:
        - Data Packages
      summary: Create a data package
      description: Creates a new data package for a data stream (requires write permission)
      operationId: createDataPackage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataStreamId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - data_package
              properties:
                data_package:
                  $ref: '#/components/schemas/DataPackageInput'
      responses:
        '201':
          description: Data package created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataPackage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_packages:
    get:
      tags:
        - Data Packages
      summary: List all data packages
      description: Returns a paginated list of data packages with optional filters
      operationId: listDataPackages
      security:
        - bearerAuth: []
      parameters:
        - name: state
          in: query
          description: 'Filter by state (comma-separated). Valid values: draft, transmitted, acknowledged'
          required: false
          schema:
            type: string
            example: 'draft,transmitted'
        - name: data_stream_id
          in: query
          description: Filter by data stream ID
          required: false
          schema:
            type: string
            format: uuid
        - name: sender_organization_id
          in: query
          description: Filter by sender organization ID
          required: false
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Successful response
          headers:
            X-Page:
              schema:
                type: integer
            X-Per-Page:
              schema:
                type: integer
            X-Total:
              schema:
                type: integer
            X-Total-Pages:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DataPackage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_packages/{id}:
    get:
      tags:
        - Data Packages
      summary: Get data package by ID
      description: Returns a single data package
      operationId: getDataPackage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataPackageId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataPackage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    delete:
      tags:
        - Data Packages
      summary: Delete a data package
      description: Deletes a data package (requires write permission, only if draft or acknowledged state)
      operationId: deleteDataPackage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataPackageId'
      responses:
        '204':
          description: Data package deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /data_packages/{id}/transmission:
    post:
      tags:
        - Transmissions
      summary: Transmit a data package
      description: Transmits a data package (transitions from draft to transmitted state, requires write permission)
      operationId: transmitDataPackage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/DataPackageId'
      responses:
        '200':
          description: Data package transmitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataPackage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /subscriptions/{id}:
    get:
      tags:
        - Subscriptions
      summary: Get subscription by ID
      description: Returns a single subscription
      operationId: getSubscription
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SubscriptionId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    put:
      tags:
        - Subscriptions
      summary: Update a subscription
      description: Updates an existing subscription
      operationId: updateSubscription
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SubscriptionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subscription
              properties:
                subscription:
                  $ref: '#/components/schemas/SubscriptionUpdateInput'
      responses:
        '200':
          description: Subscription updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'

    delete:
      tags:
        - Subscriptions
      summary: Delete a subscription
      description: Deletes a subscription
      operationId: deleteSubscription
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SubscriptionId'
      responses:
        '204':
          description: Subscription deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication. The token is generated via `organization.generate_api_token(name: 'API Prod')` 
        and returned only once. Tokens are stored as SHA256 digest with expiration and last_used_at tracking.
        Permissions: '(r) = read, (w) = write'

  parameters:
    OrganizationId:
      name: id
      in: path
      required: true
      description: Organization UUID
      schema:
        type: string
        format: uuid

    DataStreamId:
      name: id
      in: path
      required: true
      description: Data stream UUID
      schema:
        type: string
        format: uuid

    DataPackageId:
      name: id
      in: path
      required: true
      description: Data package UUID
      schema:
        type: string
        format: uuid

    SubscriptionId:
      name: id
      in: path
      required: true
      description: Subscription UUID
      schema:
        type: string
        format: uuid

    PageParam:
      name: page
      in: query
      required: false
      description: 'Page number (default: 1)'
      schema:
        type: integer
        minimum: 1
        default: 1

    PerPageParam:
      name: per_page
      in: query
      required: false
      description: 'Items per page (default: 50, max: 100)'
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 50

  schemas:
    Organization:
      type: object
      required:
        - id
        - name
        - siret
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Organization UUID
        name:
          type: string
          description: Organization name
        siret:
          type: string
          pattern: '^\d{14}$'
          description: SIRET number (14 digits), unique business identifier
          example: '12345678901234'
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp

    DataStream:
      type: object
      required:
        - id
        - name
        - owner_organization_id
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Data stream UUID
        name:
          type: string
          description: Data stream name
        description:
          type: string
          nullable: true
          description: Data stream description
        owner_organization_id:
          type: string
          format: uuid
          description: Owner organization UUID
        retention_days:
          type: integer
          nullable: true
          minimum: 1
          description: Retention period in days (null means no retention limit)
          example: 365
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp

    DataStreamInput:
      type: object
      required:
        - name
        - owner_organization_id
      properties:
        name:
          type: string
          description: Data stream name
        description:
          type: string
          nullable: true
          description: Data stream description
        owner_organization_id:
          type: string
          format: uuid
          description: Owner organization UUID
        retention_days:
          type: integer
          nullable: true
          minimum: 1
          description: Retention period in days (null means no retention limit)

    DataPackage:
      type: object
      required:
        - id
        - state
        - data_stream_id
        - sender_organization_id
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Data package UUID
        state:
          type: string
          enum:
            - draft
            - transmitted
            - acknowledged
          description: Current state of the data package
        data_stream_id:
          type: string
          format: uuid
          description: Associated data stream UUID
        sender_organization_id:
          type: string
          format: uuid
          description: Sender organization UUID
        title:
          type: string
          nullable: true
          maxLength: 255
          description: Package title (auto-generated if not provided)
        sent_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when package was sent (set when transitioning to transmitted state)
        acknowledged_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when package was acknowledged (set when transitioning to acknowledged state)
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp

    DataPackageInput:
      type: object
      required:
        - data_stream_id
        - sender_organization_id
      properties:
        data_stream_id:
          type: string
          format: uuid
          description: Associated data stream UUID (can be omitted if provided in URL path)
        sender_organization_id:
          type: string
          format: uuid
          description: Sender organization UUID
        title:
          type: string
          maxLength: 255
          description: Package title (optional, auto-generated if not provided)

    Subscription:
      type: object
      required:
        - id
        - permission_type
        - data_stream_id
        - organization_id
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Subscription UUID
        permission_type:
          type: string
          enum:
            - read
            - write
            - read_write
          description: Permission type for the subscription
        data_stream_id:
          type: string
          format: uuid
          description: Associated data stream UUID
        organization_id:
          type: string
          format: uuid
          description: Subscribed organization UUID
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp

    SubscriptionInput:
      type: object
      required:
        - organization_id
        - permission_type
      properties:
        data_stream_id:
          type: string
          format: uuid
          description: Associated data stream UUID (can be omitted if provided in URL path)
        organization_id:
          type: string
          format: uuid
          description: Subscribed organization UUID
        permission_type:
          type: string
          enum:
            - read
            - write
            - read_write
          description: Permission type for the subscription

    SubscriptionUpdateInput:
      type: object
      properties:
        permission_type:
          type: string
          enum:
            - read
            - write
            - read_write
          description: Permission type for the subscription

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message

    ValidationError:
      type: object
      description: Validation errors object with field names as keys and arrays of error messages as values
      additionalProperties:
        type: array
        items:
          type: string
      example:
        name:
          - "can't be blank"
        permission_type:
          - 'is not included in the list'

  responses:
    Unauthorized:
      description: Token invalid or expired
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Invalid or expired token

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Insufficient permissions

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not found

    ValidationError:
      description: Validation errors
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            name:
              - "can't be blank"
            permission_type:
              - is not included in the list

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per time window
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests in current time window
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Time when rate limit resets (Unix timestamp)

